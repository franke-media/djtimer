<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>DJ Stage Countdown Timer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
    --main-color: red;
}

body {
    margin: 0;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: Arial Black, Arial, sans-serif;
    color: var(--main-color);
}

.container {
    position: relative;
    width: 560px;
    height: 520px;
}

/* dB Meter */
.db-container {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 60px;
    text-align: center;
}

.db-meter {
    width: 20px;
    height: 300px;
    margin: 0 auto 10px;
    border: 2px solid #333;
    position: relative;
}

.db-level {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 0%;
    background: green;
}

.db-value {
    font-size: 14px;
    letter-spacing: 1px;
}

/* LED Ring */
.led-ring {
    position: absolute;
    inset: 0;
}

.led {
    position: absolute;
    width: 10px;
    height: 10px;
    background: #200;
    border-radius: 50%;
}

.led.on {
    background: var(--main-color);
    box-shadow: 0 0 8px var(--main-color);
}

/* Timer */
.timer {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 56px;
    letter-spacing: 3px;
    text-shadow: 0 0 14px var(--main-color);
}

.timer .ms {
    font-size: 30px;
    margin-left: 6px;
    opacity: 0.85;
}

/* Blink */
.blink {
    animation: blink 1s step-start infinite;
}

@keyframes blink {
    50% { opacity: 0.3; }
}

/* Controls */
.controls {
    position: absolute;
    bottom: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 20px;
}

button {
    background: #000;
    color: var(--main-color);
    border: 2px solid var(--main-color);
    padding: 8px 22px;
    font-size: 15px;
    cursor: pointer;
}

button:hover {
    background: var(--main-color);
    color: #000;
}
</style>
</head>

<body>

<div class="container">

    <!-- dB Meter -->
    <div class="db-container">
        <div class="db-meter">
            <div class="db-level" id="dbLevel"></div>
        </div>
        <div class="db-value" id="dbValue">–∞ dB</div>
    </div>

    <!-- LED Ring -->
    <div class="led-ring" id="ledRing"></div>

    <!-- Timer -->
    <div class="timer" id="timer">
        <span id="time">02:00:00</span><span class="ms" id="ms">.0</span>
    </div>

    <!-- Controls -->
    <div class="controls">
        <button onclick="start()">Start</button>
        <button onclick="pause()">Pause</button>
        <button onclick="resetTimer()">Reset</button>
    </div>

</div>

<script>
/* ================= TIMER ================= */

const START_TIME = 2 * 60 * 60 * 1000;
const LED_COUNT = 60;

let remaining = START_TIME;
let interval = null;

const timeDisplay = document.getElementById("time");
const msDisplay = document.getElementById("ms");
const timerEl = document.getElementById("timer");
const ledRing = document.getElementById("ledRing");

const leds = [];
const radius = 210;
const center = 300;

/* LEDs */
for (let i = 0; i < LED_COUNT; i++) {
    const led = document.createElement("div");
    led.className = "led";

    const angle = (i / LED_COUNT) * 2 * Math.PI - Math.PI / 2;
    led.style.left = center + radius * Math.cos(angle) + "px";
    led.style.top  = center + radius * Math.sin(angle) + "px";

    ledRing.appendChild(led);
    leds.push(led);
}

function updateColors(totalSeconds) {
    document.documentElement.style.setProperty("--main-color", "red");
    timerEl.classList.remove("blink");

    if (totalSeconds <= 120) {
        timerEl.classList.add("blink");
    } else if (totalSeconds <= 600) {
        document.documentElement.style.setProperty("--main-color", "yellow");
    }
}

function updateDisplay() {
    const totalSeconds = Math.floor(remaining / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const tenths = Math.floor((remaining % 1000) / 100);

    updateColors(totalSeconds);

    timeDisplay.textContent =
        String(hours).padStart(2, "0") + ":" +
        String(minutes).padStart(2, "0") + ":" +
        String(seconds).padStart(2, "0");

    msDisplay.textContent = "." + tenths;

    leds.forEach((led, i) => {
        led.classList.toggle("on", i < seconds);
    });
}

function start() {
    if (interval || remaining <= 0) return;
    interval = setInterval(() => {
        remaining -= 100;
        if (remaining < 0) remaining = 0;
        updateDisplay();
        if (remaining === 0) pause();
    }, 100);
}

function pause() {
    clearInterval(interval);
    interval = null;
}

function resetTimer() {
    pause();
    remaining = START_TIME;
    updateDisplay();
}

updateDisplay();

/* ================= dB METER ================= */

const dbLevel = document.getElementById("dbLevel");
const dbValue = document.getElementById("dbValue");

navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    const audioCtx = new AudioContext();
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;

    const mic = audioCtx.createMediaStreamSource(stream);
    mic.connect(analyser);

    const data = new Uint8Array(analyser.frequencyBinCount);

    function updateDb() {
        analyser.getByteTimeDomainData(data);

        let sum = 0;
        for (let i = 0; i < data.length; i++) {
            const v = (data[i] - 128) / 128;
            sum += v * v;
        }

        const rms = Math.sqrt(sum / data.length);
        const db = rms > 0 ? 20 * Math.log10(rms) : -Infinity;

        const clamped = Math.max(-60, db);
        const percent = ((clamped + 60) / 60) * 100;

        dbLevel.style.height = percent + "%";
        dbValue.textContent = isFinite(db) ? Math.round(db) + " dB" : "–∞ dB";

        if (db > -10) {
            dbLevel.style.background = "red";
            dbValue.style.color = "red";
        } else if (db > -25) {
            dbLevel.style.background = "yellow";
            dbValue.style.color = "yellow";
        } else {
            dbLevel.style.background = "green";
            dbValue.style.color = "green";
        }

        requestAnimationFrame(updateDb);
    }

    updateDb();
});
</script>

</body>
</html>
