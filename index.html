<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>DJ Stage Countdown Timer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
    --main-color: red;
}

body {
    margin: 0;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: Arial Black, Arial, sans-serif;
    color: var(--main-color);
}

.container {
    position: relative;
    width: 520px;
    height: 460px;
}

/* dB Meter */
.db-meter {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 300px;
    border: 2px solid #333;
}

.db-level {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 0%;
    background: green;
}

/* LED Ring */
.led-ring {
    position: absolute;
    inset: 0;
}

.led {
    position: absolute;
    width: 10px;
    height: 10px;
    background: #200;
    border-radius: 50%;
}

.led.on {
    background: var(--main-color);
    box-shadow: 0 0 8px var(--main-color);
}

/* Timer */
.timer {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 56px;
    letter-spacing: 3px;
    text-shadow: 0 0 14px var(--main-color);
}

.timer .ms {
    font-size: 30px;
    margin-left: 6px;
    opacity: 0.85;
}

/* Blink */
.blink {
    animation: blink 1s step-start infinite;
}

@keyframes blink {
    50% { opacity: 0.3; }
}
</style>
</head>

<body>

<div class="container">

    <div class="db-meter">
        <div class="db-level" id="dbLevel"></div>
    </div>

    <div class="led-ring" id="ledRing"></div>

    <div class="timer" id="timer">
        <span id="time">02:00:00</span><span class="ms" id="ms">.0</span>
    </div>

</div>

<script>
/* ================= TIMER ================= */

const START_TIME = 2 * 60 * 60 * 1000;
const LED_COUNT = 60;

let remaining = START_TIME;
let interval = null;

const timeDisplay = document.getElementById("time");
const msDisplay = document.getElementById("ms");
const timerEl = document.getElementById("timer");
const ledRing = document.getElementById("ledRing");

const leds = [];
const radius = 210;
const center = 260;

/* LEDs erzeugen */
for (let i = 0; i < LED_COUNT; i++) {
    const led = document.createElement("div");
    led.className = "led";

    const angle = (i / LED_COUNT) * 2 * Math.PI - Math.PI / 2;
    led.style.left = center + radius * Math.cos(angle) + "px";
    led.style.top  = center + radius * Math.sin(angle) + "px";

    ledRing.appendChild(led);
    leds.push(led);
}

function updateColors(totalSeconds) {
    document.documentElement.style.setProperty("--main-color", "red");
    timerEl.classList.remove("blink");

    if (totalSeconds <= 120) {
        timerEl.classList.add("blink");
    } else if (totalSeconds <= 600) {
        document.documentElement.style.setProperty("--main-color", "yellow");
    }
}

function updateDisplay() {
    const totalSeconds = Math.floor(remaining / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const tenths = Math.floor((remaining % 1000) / 100);

    updateColors(totalSeconds);

    timeDisplay.textContent =
        String(hours).padStart(2, "0") + ":" +
        String(minutes).padStart(2, "0") + ":" +
        String(seconds).padStart(2, "0");

    msDisplay.textContent = "." + tenths;

    leds.forEach((led, i) => {
        led.classList.toggle("on", i < seconds);
    });
}

function start() {
    if (interval || remaining <= 0) return;
    interval = setInterval(() => {
        remaining -= 100;
        if (remaining < 0) remaining = 0;
        updateDisplay();
        if (remaining === 0) clearInterval(interval);
    }, 100);
}

start();
updateDisplay();

/* ================= dB METER ================= */

const dbLevel = document.getElementById("dbLevel");

navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    const audioCtx = new AudioContext();
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;

    const mic = audioCtx.createMediaStreamSource(stream);
    mic.connect(analyser);

    const data = new Uint8Array(analyser.frequencyBinCount);

    function updateDb() {
        analyser.getByteFrequencyData(data);
        const avg = data.reduce((a,b)=>a+b,0)/data.length;
        const level = Math.min(100, avg);

        dbLevel.style.height = level + "%";

        if (level > 80) dbLevel.style.background = "red";
        else if (level > 50) dbLevel.style.background = "yellow";
        else dbLevel.style.background = "green";

        requestAnimationFrame(updateDb);
    }

    updateDb();
});
</script>

</body>
</html>
